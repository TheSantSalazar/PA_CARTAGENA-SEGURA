<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mapa de incidentes - Cartagena Segura">
    <title>Mapa de Incidentes - Cartagena Segura üõ°Ô∏è</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* ============================
   ESTILOS PARA MAPA: CARTAGENA SEGURA
   ============================ */

body {
    padding-top: 60px;
    background: #f2f4f7;
    font-family: "Inter", sans-serif;
}

/* =============== HEADER DEL MAPA ============== */
.map-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    color: white;
    padding: 2.6rem 1rem;
    border-radius: 0 0 22px 22px;
    margin-bottom: 2.5rem;
    box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}

.map-header h1 {
    font-weight: 800;
    margin-bottom: 0.4rem;
    font-size: 2rem;
}

/* =============== CONTENEDOR DEL MAPA =============== */
.map-container {
    background: #ffffff;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    margin-bottom: 2rem;
    position: relative;
}

#mapid {
    height: 70vh;
    min-height: 430px;
    width: 100%;
    position: relative;
}

/* =============== SPINNER =============== */
.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
}

/* =============== LEYENDA DEL MAPA =============== */
.map-legend {
    background: white;
    padding: 1.3rem;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 500;
    max-width: 280px;
    border: 1px solid #e3e6ea;
}

.legend-title {
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #1a1d20;
    font-size: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    font-size: 0.92rem;
    padding: 0.5rem;
    border-radius: 6px;
    transition: background 0.25s ease;
}

.legend-item:hover {
    background: #f2f4f7;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

/* Colores seg√∫n estados */
.legend-color.pending {
    background: #ffc107;
}

.legend-color.in-progress {
    background: #0dcaf0;
}

.legend-color.resolved {
    background: #198754;
}

/* =============== POPUP DEL MAPA (LEAFLET) =============== */
.popup-content {
    min-width: 220px;
}

.popup-content h6 {
    margin-bottom: 0.5rem;
    font-weight: 700;
    color: #1e1f22;
}

.popup-content p {
    margin-bottom: 0.3rem;
    font-size: 0.87rem;
    color: #52575d;
}

.status-badge {
    display: inline-block;
    padding: 0.3rem 0.55rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

/* Estados */
.status-PENDING {
    background: #fff3cd;
    color: #664d03;
}

.status-IN_PROGRESS {
    background: #cfe2ff;
    color: #084298;
}

.status-RESOLVED {
    background: #d1e7dd;
    color: #0f5132;
}

/* =============== INFO SECCI√ìN =============== */
.map-info {
    padding: 1.8rem;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    border: 1px solid #e6e8ea;
}

/* TARJETAS DE ESTADISTICAS */
.map-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1.3rem;
    margin-top: 1.5rem;
}

.stat-card {
    background: white;
    padding: 1.2rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    border: 1px solid #eef0f2;
}

.stat-number {
    font-size: 1.9rem;
    font-weight: 800;
    color: #0d6efd;
}

.stat-label {
    font-size: 0.85rem;
    margin-top: 0.3rem;
    color: #666;
}

/* =============== ALERTA INFORMATIVA =============== */
.alert-info-box {
    background: #e7f3ff;
    border-left: 5px solid #0d6efd;
    padding: 1.2rem;
    border-radius: 6px;
    margin-bottom: 1.5rem;
    color: #0b396f;
    font-size: 0.95rem;
}

/* =============== RESPONSIVE =============== */
@media (max-width: 768px) {
    #mapid {
        height: 52vh;
    }

    .map-legend {
        bottom: 10px;
        right: 10px;
        max-width: 90vw;
    }

    .map-header h1 {
        font-size: 1.6rem;
    }
}

    </style>
</head>
<body>

<!-- Navbar -->
<div id="navbar-container"></div>

<!-- Map Header -->
<div class="map-header">
    <div class="container">
        <h1>üó∫Ô∏è Mapa de Incidentes Activos</h1>
        <p class="mb-0">Visualizaci√≥n geogr√°fica de incidentes reportados en Cartagena</p>
    </div>
</div>

<div class="container my-4">
    <!-- Alert Container -->
    <div id="mapAlert"></div>

    <!-- Info Box -->
    <div class="alert-info-box">
        <strong>üí° Informaci√≥n:</strong>
        Haz clic en los marcadores para ver detalles de cada incidente.
        Los marcadores est√°n coloreados seg√∫n el estado:
        <span class="badge bg-warning">Pendiente</span>
        <span class="badge bg-info">En Progreso</span>
        <span class="badge bg-success">Resuelto</span>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        <div id="mapid" style="position: relative;">
            <div class="loading-spinner" id="mapSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando mapa...</span>
                </div>
            </div>
        </div>

        <!-- Map Legend -->
        <div class="map-legend" id="mapLegend">
            <div class="legend-title">üéØ Leyenda</div>
            <div class="legend-item">
                <div class="legend-color pending"></div>
                <span>Pendiente</span>
            </div>
            <div class="legend-item">
                <div class="legend-color in-progress"></div>
                <span>En Progreso</span>
            </div>
            <div class="legend-item">
                <div class="legend-color resolved"></div>
                <span>Resuelto</span>
            </div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="map-info">
        <h5>üìä Estad√≠sticas de Incidentes</h5>
        <div class="map-stats" id="mapStats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="progressCount">0</div>
                <div class="stat-label">En Progreso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="resolvedCount">0</div>
                <div class="stat-label">Resueltos</div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>

<script>
    // Actualizar MapManager para nuevo modelo
    const MapManagerUpdated = {
        ...MapManager,

        async loadIncidentsForMap() {
            try {
                document.getElementById('mapSpinner').style.display = 'block';
                Logger.info('Cargando incidentes para mapa');

                const incidents = await APIClient.get(CONFIG.ENDPOINTS.INCIDENTS);

                document.getElementById('mapSpinner').style.display = 'none';
                this.initializeMap(incidents);
                this.updateStats(incidents);
            } catch (error) {
                document.getElementById('mapSpinner').style.display = 'none';
                Logger.error('Error al cargar mapa', error);
                UIHelper.showAlert('mapAlert', `‚ùå ${error.message}`, 'error');
            }
        },

        initializeMap(incidents) {
            const mapContainer = document.getElementById('mapid');
            if (!mapContainer) {
                Logger.warn('Contenedor del mapa no encontrado');
                return;
            }

            // Limpiar mapa anterior
            if (this.map) {
                this.map.remove();
            }

            // Crear mapa centrado en Cartagena
            this.map = L.map('mapid').setView([10.3826, -75.5149], 13);

            // Agregar tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(this.map);

            // Agregar marcadores
            let markersAdded = 0;
            const bounds = L.latLngBounds();

            incidents.forEach(incident => {
                // Usar lat y lng separados
                const lat = incident.lat;
                const lng = incident.lng;

                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                    Logger.warn(`Coordenadas inv√°lidas para incidente ${incident.id}`);
                    return;
                }

                // Determinar color seg√∫n estado
                const colors = {
                    'PENDING': '#ffc107',
                    'IN_PROGRESS': '#0dcaf0',
                    'RESOLVED': '#198754'
                };
                const color = colors[incident.status] || '#0dcaf0';

                // Crear icono personalizado
                const icon = L.divIcon({
                    html: `
                        <div style="
                            background: ${color};
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border: 3px solid white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            font-weight: bold;
                            color: white;
                            font-size: 16px;
                        ">
                            üìç
                        </div>
                    `,
                    className: 'custom-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                // Crear popup
                const popupContent = `
                    <div class="popup-content">
                        <h6>#${incident.id}</h6>
                        <p><strong>Tipo:</strong> ${incident.type}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${incident.location}</p>
                        <p><strong>Descripci√≥n:</strong> ${incident.description}</p>
                        <p><strong>Coordenadas:</strong></p>
                        <p style="font-family: monospace; font-size: 0.8rem;">
                            ${incident.lat?.toFixed(4)}, ${incident.lng?.toFixed(4)}
                        </p>
                        <span class="status-badge status-${incident.status}">
                            ${incident.status}
                        </span>
                    </div>
                `;

                // Agregar marcador
                L.marker([lat, lng], { icon })
                    .addTo(this.map)
                    .bindPopup(popupContent, { maxWidth: 300 });

                bounds.extend([lat, lng]);
                markersAdded++;
            });

            // Ajustar vista a todos los marcadores
            if (markersAdded > 0 && bounds.isValid()) {
                this.map.fitBounds(bounds, { padding: [50, 50] });
            }

            Logger.success(`${markersAdded} marcadores a√±adidos al mapa`);
        },

        updateStats(incidents) {
            const total = incidents.length;
            const pending = incidents.filter(i => i.status === 'PENDING').length;
            const progress = incidents.filter(i => i.status === 'IN_PROGRESS').length;
            const resolved = incidents.filter(i => i.status === 'RESOLVED').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('progressCount').textContent = progress;
            document.getElementById('resolvedCount').textContent = resolved;

            Logger.info(`Stats - Total: ${total}, Pendientes: ${pending}, En Progreso: ${progress}, Resueltos: ${resolved}`);
        }
    };

    // Reemplazar m√©todos
    Object.assign(MapManager, MapManagerUpdated);

    // Inicializar cuando carga
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof PageInitializer !== 'undefined') {
            PageInitializer.checkAuthAndLoad();
        }
    });
</script>

</body>
</html>