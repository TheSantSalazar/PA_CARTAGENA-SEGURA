<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gesti√≥n de incidentes - Cartagena Segura">
    <title>Gesti√≥n de Incidentes - Cartagena Segura üõ°Ô∏è</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* ============================= */
/* ESTILO PROFESIONAL DASHBOARD  */
/* ============================= */

:root {
    --primary: #0d6efd;
    --primary-dark: #0b5ed7;
    --success: #198754;
    --warning: #ffc107;
    --danger: #dc3545;
    --info: #0dcaf0;

    --bg-soft: #f5f7fa;
    --text-dark: #2d3436;
    --card-shadow: 0 6px 18px rgba(0,0,0,0.06);
    --transition: all 0.25s ease;
}

body {
    background-color: var(--bg-soft);
    font-family: "Inter", system-ui, sans-serif;
    padding-top: 70px;
}

/* ============================= */
/* HEADER                        */
/* ============================= */

.page-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 2.8rem 0;
    text-shadow: 0 2px 5px rgba(0,0,0,0.25);
}

.page-header h1 {
    font-weight: 800;
    font-size: 2.4rem;
}

.page-header p {
    opacity: 0.9;
    font-size: 1.1rem;
}

/* ============================= */
/* TABS                          */
/* ============================= */

.nav-tabs-custom {
    background: #fff;
    border-radius: 12px 12px 0 0;
    box-shadow: var(--card-shadow);
}

.nav-tabs-custom .nav-link {
    font-weight: 600;
    padding: 1rem 1.25rem;
    color: #6c757d;
    border: none;
    transition: var(--transition);
}

.nav-tabs-custom .nav-link.active {
    color: var(--primary);
    border-bottom: 3px solid var(--primary);
}

.nav-tabs-custom .nav-link:hover {
    color: var(--primary);
}

/* ============================= */
/* FILTERS + CARDS               */
/* ============================= */

.filter-section,
.form-section {
    background: white;
    padding: 1.8rem;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
}

.filter-section label {
    font-weight: 700;
    color: var(--text-dark);
}

/* ============================= */
/* TABLE                         */
/* ============================= */

.table-wrapper {
    background: white;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.table thead {
    background: #eef1f5;
}

.table thead th {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .4px;
    color: #495057;
}

.table tbody tr {
    transition: var(--transition);
}

.table tbody tr:hover {
    background: #f3f6fa;
}

/* ============================= */
/* BADGES ESTADOS                */
/* ============================= */

.status-badge {
    padding: .45rem .75rem;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.8rem;
}

.status-PENDING {
    background: #fff3cd;
    color: #866500;
}

.status-IN_PROGRESS {
    background: #cfe2ff;
    color: #084298;
}

.status-RESOLVED {
    background: #d1e7dd;
    color: #0f5132;
}

/* ============================= */
/* FORMULARIOS                   */
/* ============================= */

.form-label {
    font-weight: 700;
    color: var(--text-dark);
}

.form-control,
.form-select {
    border: 2px solid #e3e6ea;
    border-radius: 10px;
    padding: .85rem;
    transition: var(--transition);
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(13,110,253,.12);
}

/* ============================= */
/* BOTONES                       */
/* ============================= */

.btn-submit {
    padding: .85rem 2rem;
    font-weight: 700;
    border-radius: 10px;
    transition: var(--transition);
}

.btn-submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

.btn-outline-secondary:hover {
    background: #f0f0f0;
}

/* Geoloc button */
.btn-geo {
    margin-top: .5rem;
    background: var(--info);
    font-weight: 600;
    border-radius: 8px;
}

/* ============================= */
/* MODAL                         */
/* ============================= */

.modal-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border-radius: 8px 8px 0 0;
}

.modal-content {
    border-radius: 12px;
    box-shadow: var(--card-shadow);
}

/* ============================= */
/* RESPONSIVE                    */
/* ============================= */

@media (max-width: 768px) {
    .page-header h1 {
        font-size: 1.8rem;
    }

    .btn-group-custom {
        flex-direction: column;
        gap: .75rem;
    }

    .btn-submit {
        width: 100%;
    }
}

    </style>
</head>
<body>

<!-- Navbar -->
<div id="navbar-container"></div>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>üìã Gesti√≥n de Incidentes</h1>
        <p class="mb-0">Administra, consulta y actualiza el estado de incidentes reportados</p>
    </div>
</div>

<div class="container my-5">
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container mb-3"></div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs nav-tabs-custom" id="incidentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                    class="nav-link active"
                    id="list-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#list-pane"
                    type="button"
                    role="tab">
                üìë Listado de Incidentes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                    class="nav-link"
                    id="create-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#create-pane"
                    type="button"
                    role="tab">
                ‚ûï Reportar Nuevo
            </button>
        </li>
    </ul>

    <div class="tab-content" id="incidentTabsContent">
        <!-- LIST TAB -->
        <div class="tab-pane fade show active" id="list-pane" role="tabpanel">
            <!-- Filter Section -->
            <div class="filter-section">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label for="statusFilter" class="form-label">üîç Filtrar por Estado</label>
                        <select class="form-select" id="statusFilter">
                            <option value="ALL">Todos los Estados</option>
                            <option value="PENDING">‚è≥ Pendiente</option>
                            <option value="IN_PROGRESS">üîÑ En Progreso</option>
                            <option value="RESOLVED">‚úÖ Resuelto</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-sm btn-outline-primary" id="refreshBtn" onclick="IncidentManager.loadIncidents()">
                            üîÑ Recargar Lista
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-wrapper">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipo</th>
                            <th>Descripci√≥n</th>
                            <th>Ubicaci√≥n</th>
                            <th>Coordenadas</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="incidentTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <p>Cargando incidentes...</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CREATE TAB -->
        <div class="tab-pane fade" id="create-pane" role="tabpanel">
            <div class="form-section">
                <h3>üìù Reportar Nuevo Incidente</h3>
                <form id="createIncidentForm" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="type" class="form-label">Tipo de Incidente</label>
                                <input
                                        type="text"
                                        class="form-control"
                                        id="type"
                                        placeholder="Ej: Robo, Inundaci√≥n, Accidente"
                                        required
                                        minlength="3"
                                        maxlength="50">
                                <div class="form-text">Describe brevemente el tipo de incidente</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="location" class="form-label">üìç Ubicaci√≥n (Nombre del lugar)</label>
                                <input
                                        type="text"
                                        class="form-control"
                                        id="location"
                                        placeholder="Ej: Centro hist√≥rico, Parque Bol√≠var"
                                        required
                                        minlength="3"
                                        maxlength="100">
                                <div class="form-text">Nombre descriptivo de la ubicaci√≥n</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="lat" class="form-label">üìç Latitud</label>
                                <input
                                        type="number"
                                        class="form-control"
                                        id="lat"
                                        placeholder="10.3997"
                                        step="0.0001"
                                        required
                                        min="-90"
                                        max="90">
                                <div class="form-text">Ej: 10.3997 (rango: -90 a 90)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="lng" class="form-label">üìç Longitud</label>
                                <input
                                        type="number"
                                        class="form-control"
                                        id="lng"
                                        placeholder="-75.5144"
                                        step="0.0001"
                                        required
                                        min="-180"
                                        max="180">
                                <div class="form-text">Ej: -75.5144 (rango: -180 a 180)</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button
                                type="button"
                                class="btn-geo"
                                id="geoBtn"
                                onclick="requestUserLocation()">
                            üìç Detectar mi Ubicaci√≥n
                        </button>
                        <div id="geoStatus" class="coordinate-display" style="display: none;">
                            <strong>Ubicaci√≥n detectada:</strong><br>
                            <span id="geoCoords"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">Descripci√≥n Detallada</label>
                        <textarea
                                class="form-control"
                                id="description"
                                rows="4"
                                placeholder="Proporciona detalles completos del incidente..."
                                required
                                minlength="10"
                                maxlength="500"></textarea>
                        <div class="form-text">M√≠nimo 10 caracteres, m√°ximo 500</div>
                    </div>

                    <div class="btn-group-custom">
                        <button type="submit" class="btn btn-submit btn-primary" id="submitBtn">
                            ‚úÖ Crear Incidente
                        </button>
                        <button type="reset" class="btn btn-submit btn-outline-secondary" onclick="clearGeoStatus()">
                            üîÑ Limpiar Formulario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">‚úèÔ∏è Actualizar Estado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="mb-1"><strong>Incidente ID:</strong></p>
                    <p class="text-muted" id="modalIncidentId">-</p>
                </div>
                <div class="form-group">
                    <label for="newStatus" class="form-label">Nuevo Estado</label>
                    <select class="form-select" id="newStatus">
                        <option value="">Seleccionar estado...</option>
                        <option value="PENDING">‚è≥ Pendiente</option>
                        <option value="IN_PROGRESS">üîÑ En Progreso</option>
                        <option value="RESOLVED">‚úÖ Resuelto</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn" onclick="IncidentManager.updateStatus()">
                    üíæ Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>
<script src="js/geolocation.js"></script>

<script>
    // Actualizar IncidentManager para nuevo modelo
    const IncidentManagerUpdated = {
        ...IncidentManager,

        renderIncidents(incidents) {
            const tableBody = document.getElementById('incidentTableBody');
            if (!tableBody) return;

            if (!incidents || incidents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            üì≠ No hay incidentes para mostrar
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = incidents.map(incident => `
                <tr>
                    <td><strong>${incident.id}</strong></td>
                    <td>${incident.type}</td>
                    <td>${incident.description}</td>
                    <td>${incident.location || '‚Äî'}</td>
                    <td>
                        <small style="font-family: monospace;">
                            ${incident.lat?.toFixed(4)}, ${incident.lng?.toFixed(4)}
                        </small>
                    </td>
                    <td>
                        <span class="status-badge status-${incident.status}">
                            ${incident.status}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-info btn-sm" onclick="IncidentManager.openStatusModal('${incident.id}', '${incident.status}')">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="IncidentManager.deleteIncident('${incident.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        },

        async createIncident(event) {
            event.preventDefault();

            const type = document.getElementById('type')?.value?.trim();
            const description = document.getElementById('description')?.value?.trim();
            const location = document.getElementById('location')?.value?.trim();
            const lat = parseFloat(document.getElementById('lat')?.value);
            const lng = parseFloat(document.getElementById('lng')?.value);

            // Validar campos
            if (!type || !description || !location || isNaN(lat) || isNaN(lng)) {
                UIHelper.showToast('‚ö†Ô∏è Por favor completa todos los campos correctamente', 'warning');
                return;
            }

            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                UIHelper.showToast('‚ö†Ô∏è Coordenadas fuera de rango', 'warning');
                return;
            }

            const newIncident = {
                type,
                description,
                location,
                lat,
                lng
            };

            try {
                UIHelper.setButtonLoading('submitBtn', true);

                const result = await APIClient.post(CONFIG.ENDPOINTS.INCIDENTS, newIncident);

                Logger.success('Incidente creado');
                UIHelper.showToast('‚úÖ Incidente creado exitosamente', 'success');

                document.getElementById('createIncidentForm')?.reset();
                clearGeoStatus();
                document.querySelector('[data-bs-target="#list-pane"]')?.click();

                this.loadIncidents();
            } catch (error) {
                Logger.error('Error al crear incidente', error);
                UIHelper.showToast(`‚ùå ${error.message}`, 'error');
            } finally {
                UIHelper.setButtonLoading('submitBtn', false);
            }
        }
    };

    // Reemplazar m√©todos
    Object.assign(IncidentManager, IncidentManagerUpdated);

    // Funciones globales
    function requestUserLocation() {
        const geoBtn = document.getElementById('geoBtn');
        geoBtn.classList.add('loading');
        geoBtn.disabled = true;
        geoBtn.textContent = '‚è≥ Detectando...';

        GeolocationManager.getCurrentLocation()
            .then(location => {
                document.getElementById('lat').value = location.lat.toFixed(4);
                document.getElementById('lng').value = location.lng.toFixed(4);

                const geoStatus = document.getElementById('geoStatus');
                document.getElementById('geoCoords').textContent = `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`;
                geoStatus.style.display = 'block';

                UIHelper.showToast('‚úÖ Ubicaci√≥n detectada correctamente', 'success');
                Logger.success('Ubicaci√≥n: ' + `${location.lat}, ${location.lng}`);
            })
            .catch(error => {
                UIHelper.showToast(`‚ö†Ô∏è ${error.message}`, 'warning');
                Logger.warn('Error en geolocalizaci√≥n:', error);
            })
            .finally(() => {
                geoBtn.classList.remove('loading');
                geoBtn.disabled = false;
                geoBtn.textContent = 'üìç Detectar mi Ubicaci√≥n';
            });
    }

    function clearGeoStatus() {
        document.getElementById('geoStatus').style.display = 'none';
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        IncidentManager.loadIncidents();

        const createForm = document.getElementById('createIncidentForm');
        if (createForm) {
            createForm.addEventListener('submit', (e) => {
                IncidentManager.createIncident(e);
            });
        }

        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', (e) => {
                IncidentManager.loadIncidents(e.target.value);
            });
        }
    });

    window.openStatusModal = (id, status) => {
        IncidentManager.openStatusModal(id, status);
    };
</script>

</body>
</html>